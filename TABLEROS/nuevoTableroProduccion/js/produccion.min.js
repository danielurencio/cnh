$(function() {
  document.getElementById("chkAsignaciones").checked;
  document.getElementById("chkContratos").checked;
  document.getElementById("dataTypeGas").checked = false;
  document.getElementById("dataTypeOil").checked = true;
  document.getElementById("sYear").value = 2016;
  document.getElementById("sMonth").value = "01";
  document.getElementById("eYear").value = 2017;
  document.getElementById("eMonth").value = "06";

  d3.select("div.dashboard-content").style("padding",0);
  var divWidth = d3.select("div#chart").style("width").split("p")[0]//window.innerWidth;
  var divHeight = window.innerHeight;
  var frameHeight = +d3.select("div.dashboard-content")
	.style("height").split("p")[0];
  
  d3.select("div#chart")
    .style("height",(divHeight-frameHeight)+"px")
    .style("width","100%");

/*
  d3.select("div#chart")
    .append("svg")
    .attr({
      "width": divWidth,
      "height": (divHeight - frameHeight),
      "id":"chart"
    });
*/

// ---------------------------------------------------------------------------|
// INICIO DE WORDCLOUD DEL LADO IZQUIERDO. <]=^D
// ---------------------------------------------------------------------------|

  var nombresCamposInicio = ajaxConfig();
  nombresCamposInicio.url = "http://portal.cnih.cnh.gob.mx/api/nombres_campos.py";
  nombresCamposInicio.data = {
	  'type': 'oil',
	  'sdate': '2016-01-01',
	  'edate': '2017-06-01', // <-- OJO! ¿No debería de actualizarse?
	  'contract': 'Asignaciones;Contratos;',//tipos(),
	  'operator': '',
	  'category': 'phidro;',
	  'field': 'all;',
	  'term':''
  };


  nombresCamposInicio.success = function(response) {
    var campos = JSON.parse(response);
    var Sizes = campos.map(function(d) { return d.size; });
    var tipos = campos.map(function(d) { return d.type; })

    var scale = d3.scale.linear()
	.domain(d3.extent(Sizes))
	.range([10,22])

// ---------------------------------------------------------------------------|
// INSERTAR WORDLCLOUD. <]=^D
// ---------------------------------------------------------------------------|

    d3.select("ul.campos").selectAll("li")
      .data(campos).enter().append("li").append("mark")
	.html(function(d) { return d.name; })
	.style("color",function(d) { 
	  if(d.type == "Terrestre") return "black";
	  else return "rgba(51,171,249,1)";
	})
	.style("font-size", function(d) { return String(scale(d.size)) + "px"; })
	.on("mouseover", function(d) {
	  d3.select(this).style("color","white");
	})
	.on("mouseout",function(d) {
	  if(d.type == "Terrestre") d3.select(this).style("color","black");
	  else d3.select(this).style("color","rgba(51,171,249,1)");
	})
	.on("click", function(d) {
// ---------------------------------------------------------------------------|
// GRAFICAR SERIES DESDE EL WORD CLOUD. <]=^D
// ---------------------------------------------------------------------------|
	  var field = d3.select(this).html();
	  var field_ = field.split(" ").reduce(function sum(a,b) {
	    return a + "_" + b;
	  });
	  var activ = { 'field':field };
/*----------ESTO ILUMINA Y APAGA LOS NOMBRES DE LOS CAMPOS EN EL WORDCLOUD---*/
	  if(d3.select(this).attr("class")) {
	    d3.select(this).style("background-color",null)
	    d3.select(this).attr("class",null)
	    activ.erase = true;
	  } else {
	    d3.select(this).style("background-color","red")
	    d3.select(this).attr("class","selected")
	    activ.erase = false;
	  }
/*--------AQUÍ INICIA EL AJAX PARA TRAER LAS SERIES DE TIEMPO POR CAMPO------*/
	  var obj = ajaxConfig();
	  obj.data = getFormValues();
	  obj.data.field = field;
	  obj.url = "http://portal.cnih.cnh.gob.mx/api/produccion_campos.py";

	  obj.success = function(response) {
/*--------ESTO HACE LA TRANSICIÓN DEL GRÁFICO EN D3.JS, USAR HIGHCHARTS.JS---*/
	     //chartC.axisTransition(data,activ);
	     var data = parseResponse(response);
	     var name = response.columns[0].name;
	     if(!activ.erase) {
	       if( chart.series.length > 0 && chart.series[0].name == "NACIONAL") chart.series[0].remove();
	         chart.addSeries({ 'name':name, 'data':data });
		 d3.selectAll(".highcharts-grid-line").remove();
	     } else {
	       chart.series.filter(function(d) {
		return d.name == activ.field;
	       })[0].remove();
	       d3.selectAll(".highcharts-grid-line").remove();
	     };
	  };

	  AJAX(obj);
	});
     
  };

  AJAX(nombresCamposInicio);


// ---------------------------------------------------------------------------|
// INICIO DE GRÁFICO DE SERIES DE TIEMPO DEL LADO DERECHO. <]=^D
// ---------------------------------------------------------------------------|

  var margin = {
    width:divWidth*1,
    height:divHeight-frameHeight,
    top: 0,
    right: 50,
    bottom: 30,
    left: 100,
    transform: [divWidth*0,0]
  };
  var parseDate = d3.time.format("%Y-%m-%d").parse;

// ---------------------------------------------------------------------------|
// CREAR UNA INSTANCIA DEL OBJETO Highcharts.chart, Y PASAR LAS OPCIONES.
// ---------------------------------------------------------------------------|
    var options = {
/*	 tooltip: { formatter: function() {
	   var date = new Date(this.x)
	   var month = date.getMonth() + 1;
	   var year = date.getYear();
	   return month + " - " + year;
	 } },*/
tooltip: { 'dateTimeLabelFormats': { 'month':'%b \ %Y' } },
//	 labels: { enabled: false },
	 credits: { enabled:false },
	 title: { text:"" },
	 chart: { renderTo: 'chart', type: 'line' },
	 xAxis: {
	   type:'datetime',
	   'gridLineWidth':0,
	   dateTimeLabelFormats: { month:'%m / %Y' },
	 },
	 yAxis: [{
	   lineColor:'red', 
	   title: { text:'Petróleo (Mbd)' },
	 },
	 {
	   title: { text:'Gas (MMpcd)' },
	   opposite:true
	 }],
	 series: []
	};

    var chart = new Highcharts.chart("chart", options) // <-- Instancia HC.js
    
// ---------------------------------------------------------------------------|
// CONSULTA DE AJAX INICIAL PARA GRÁFICO CON LA PRODUCCIÓN NACIONAL
// ---------------------------------------------------------------------------|

  var produccionCamposInicio = JSON.parse(JSON.stringify(nombresCamposInicio));
  produccionCamposInicio.url = "http://portal.cnih.cnh.gob.mx/api/produccion_campos.py";
  produccionCamposInicio.operator = 1;
  produccionCamposInicio.success = function(response) {
/*---------AGREGAR PRIMERA SERIE A HIGHCHARTS:PRODUCCIÓN NACIONAL------------*/
	   var data = parseResponse(response);
	   var name = response.columns[0].name;
	   var x = { 'gridLineWidth':0 };
/*---------CAMBIAR NOMBRE DE Y AXIS DE ACUERDO A SI ES PETRÓLEO O GAS--------*/
/*
	   var tipo = response.columns[0].type;
	   if(tipo == 'oil') {
	     chart.update({ 'yAxis': {
		'title': { 'text':'Petróleo (Mbd)' } 
	     }});
	   };
	   if(tipo == 'gas') {
	     chart.update({ 'yAxis': {
		'title': { 'text':'Gas (MMpcd)' } 
	     }});
	   };
*/
	   chart.addSeries({ 'name':name,'data':data });
	   d3.selectAll(".highcharts-grid-line").remove();
	};

  AJAX(produccionCamposInicio);


// ---------------------------------------------------------------------------|
// ACTUALIZACIÓN DE SERIE DE TIEMPO CON PARÁMETROS DE LAS FORMAS.
// ---------------------------------------------------------------------------|

  $("#setFilter").click(function() {
    var arr = [];
    var selected = document.getElementsByClassName("selected");

    for(var i in selected) {
      var dd = selected[i].textContent;
      if(dd) arr.push(dd);
    };

    var formValues = getFormValues();
    if(selected.length > 0) {
      selected = arr.reduce(function sum(a,b) { return a + ";" + b; });
      selected = selected + ";";
      formValues.field = selected;
    }

//    if(selected.length == 0) formValues.field = "all;";

//"http://172.16.24.57/pruebas_ws/produccion_campos_html.py"
//"http://portal.cnih.cnh.gob.mx/api/produccion_campos.py"
    var makeStr = JSON.stringify(produccionCamposInicio);
    var produccionConClick = JSON.parse(makeStr);
    produccionConClick.data = formValues;
    produccionConClick.success = function(response) {
	 console.log(response)
	   var data = parseResponse(response);
	   var series = [];
	   for(var i=1; i<data[0].length; i++) {
	     var serie = data.map(function(d) { return [d[0],d[i]]; });
	     series.push({ 'name':response.columns[i-1].name,'data':serie });
	   };
/*
	   var tipo = response.columns[0].type;
	   if(tipo == 'oil') {
	     chart.update({ 'yAxis': {
		'title': { 'text':'Petróleo (Mbd)' } 
	     }});
	   };
	   if(tipo == 'gas') {
	     chart.update({ 'yAxis': {
		'title': { 'text':'Gas (MMpcd)' } 
	     }});
	   };
*/

	   chart.update({ 'series': series });
	   d3.selectAll(".highcharts-grid-line").remove();
    }

    AJAX(produccionConClick);
  });
});



function AJAX(obj) {
    $.ajax(obj);
};

function getFormValues() {
    var chkAsignaciones = document.getElementById("chkAsignaciones").checked;
    var chkContratos = document.getElementById("chkContratos").checked;
    var dataTypeGas = document.getElementById("dataTypeGas").checked;
    var dataTypeOil = document.getElementById("dataTypeOil").checked;
    var sYear = document.getElementById("sYear").value;
    var sMonth = document.getElementById("sMonth").value;
    var eYear = document.getElementById("eYear").value;
    var eMonth = document.getElementById("eMonth").value;
    var operator = document.getElementById("dataOperator").value;
    var f = { 'sYear':sYear, 'sMonth':sMonth, 'eYear':eYear, 'eMonth':eMonth };

    function type() {
	var t;
	if(dataTypeGas && dataTypeOil) {
	  t = "oil;gas";
	}
	if(dataTypeGas && !dataTypeOil) {
	  t = "gas";
	}
	if(!dataTypeGas && dataTypeOil) {
	  t = "oil";
	}

	return t;
    };

    function Periodicidad() {
	var periodicidad;
	var arr = document.getElementsByClassName("periodicidad");
	for(var i in arr) {
	  if(arr[i].checked) periodicidad = arr[i].value;
	}

	return periodicidad;
    };

    function fecha(f) {
	var obj = { 'sDate':'', 'eDate':'' };
	obj.sDate = f.sYear + '-' + f.sMonth + '-01';
	obj.eDate = f.eYear + '-' + f.eMonth + '-01';

	return obj;
    };

    var tipos = function() {
	var result = d3.selectAll('input[name=inpTipos]')[0]
	  .filter(function(d) { return d.checked; })
	  .map(function(d) { return d.value; })
	  .reduce(function sum(a,b) { return a + ";" + b; });

	return result + ";";
    };

    var obj = {
	  'type': type(),
	  'sdate': fecha(f).sDate,
	  'edate': fecha(f).eDate,
	  'contract': tipos(),
	  'operator': operator,
	  'category': 'phidro;',
	  'field': 'all;', // <---------------- ¡OJO! Crear función también.
	  'term':Periodicidad()
    };

    return obj;
}

function ajaxConfig() {
    var obj = {
	url:"",
	type:"post",
	datatype:"json",
	data: {},
	success: function(response) {
	   console.log(response);
	},
	error: function() { console.log("!"); }
    }

    return obj;
}

function parseResponse(obj) {
   obj.columns.forEach(function(d,i) {
      if(d.type == 'oil') console.log(i);
   });
   var data = [];
   obj.data.forEach(function(d) {
//     var date = d[0].split("-");
//     date = Date.UTC(date[0],date[1],date[2]);
     var a = Date.parse(d[0]);
     var date = a + (60*60*1000*6);
     d[0] = date//new Date(date);
     data.push(d);
   });
   return data;
};
