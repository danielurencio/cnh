$(function() {
  d3.select("div.dashboard-content").style("padding",0);
  var divWidth = d3.select("div#chart").style("width").split("p")[0]//window.innerWidth;
  var divHeight = window.innerHeight;
  var frameHeight = +d3.select("div.dashboard-content")
	.style("height").split("p")[0];
  
  d3.select("div#chart").style("height",(divHeight-frameHeight))

  d3.select("div#chart")
    .append("svg")
    .attr({
      "width": divWidth,
      "height": (divHeight - frameHeight),
      "id":"chart"
    });

  var nombresCamposInicio = ajaxConfig();
  nombresCamposInicio.url = "http://portal.cnih.cnh.gob.mx/api/nombres_campos.py";
  nombresCamposInicio.data = {
	  'type': 'oil',
	  'sdate': '2016-01-01',
	  'edate': '2017-06-01', // <-- OJO! ¿No debería de actualizarse?
	  'contract': 'Asignaciones;Contratos;',//tipos(),
	  'operator': '',
	  'category': 'phidro;',
	  'field': 'all;',
	  'term':''
  };

  nombresCamposInicio.success = function(response) {
    var campos = JSON.parse(response);
    d3.select("ul.campos").selectAll("li")
      .data(campos).enter().append("li")
	.html(function(d) { return d.name; })
     

/*    var wc = d3.select("svg#chart").append("g").attr("id","wc");
    var campos = JSON.parse(response);
    wc.append("rect")
      .attr({
	"x":0,
	"y":0,
	"width":divWidth*0.3,
	"height":(divHeight-frameHeight),
	"fill":"rgba(0,0,0,0.1)"
      });

    wc.selectAll("text").data(campos)
        .enter().append("text")
      .attr({
	"x": function(d,i) {
	  return 0;
	},
	"y": function(d,i) {
	  return 10;
	}
      }).text(function(d) { return d.name; });
*/
  };

  AJAX(nombresCamposInicio);


  var margin = {
    width:divWidth*.7,
    height:divHeight-frameHeight,
    top: 0,
    right: 50,
    bottom: 30,
    left: 50,
    transform: [divWidth*0.3,0]
  };
  var parseDate = d3.time.format("%Y-%m-%d").parse;

  var produccionCamposInicio = JSON.parse(JSON.stringify(nombresCamposInicio));
  produccionCamposInicio.url = "http://portal.cnih.cnh.gob.mx/api/produccion_campos.py";
  produccionCamposInicio.operator = 1;
  produccionCamposInicio.success = function(response) {
//	   console.log(tipos());
	   var data = [];
	   response.data.forEach(function(d) {
	     var doc = { 'date':d[0], 'close':d[1] };
	     data.push(doc);
	   });
	   if(d3.select("svg#chart>g#chart")) d3.select("g#chart").remove()
	   chart(data,"svg#chart",margin,parseDate)
//	   d3.select("#tabla").html(response);
	};

  AJAX(produccionCamposInicio);

  $("#setFilter").click(function() {

    var formValues = getFormValues();
//"http://172.16.24.57/pruebas_ws/produccion_campos_html.py"
//"http://portal.cnih.cnh.gob.mx/api/produccion_campos.py"

    var produccionConClick = JSON.parse(JSON.stringify(produccionCamposInicio));
    produccionConClick.data = formValues;
    produccionConClick.success = function(response) {
           var data = [];
           response.data.forEach(function(d) {
             var doc = { 'date':d[0], 'close':d[1] };
             data.push(doc);
           });
           if(d3.select("g#chart")) d3.select("g#chart").remove()
           chart(data,"svg#chart",margin,parseDate)
//         d3.select("#tabla").html(response);
    }

    AJAX(produccionConClick);
  })
});

function chart(data,selection,margin,parseDate) {
// Parse the date / time

 data.forEach(function(d) {
  d.date = parseDate(d.date);
  d.close = +d.close;
 });

 var width = margin.width - margin.left - margin.right;
 var height = margin.height - margin.top - margin.bottom;

// Set the ranges
 var x = d3.time.scale().range([0, width]);
 var y = d3.scale.linear().range([height, 0]);

// Define the axes
 var xAxis = d3.svg.axis().scale(x)
  .orient("bottom").ticks(5);

 var yAxis = d3.svg.axis().scale(y)
  .orient("left").ticks(5);

// Define the line
 var valueline = d3.svg.line()
  .x(function(d) { return x(d.date); })
  .y(function(d) { return y(d.close); });

// Adds the svg canvas
 var svg = d3.select(selection)
  .append("g").attr("id","chart")
.append("svg").style({"display":"block","margin":"auto"})
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g")
  .attr("transform","translate(" + margin.left + "," + margin.top + ")");

// Scale the range of the data
 x.domain(d3.extent(data, function(d) { return d.date; }));
 y.domain(d3.extent(data, function(d) { return d.close; }));

// Add the valueline path.
 svg.append("path")
  .attr("class", "line")
  .attr("d", valueline(data))
  .attr("stroke-dasharray",function(d){
    var largo = d3.select(".line").node().getTotalLength();
    return String(largo) + " " + String(largo);
  })
  .attr("stroke-dashoffset",function(d) {
    var largo = d3.select(".line").node().getTotalLength();
    return largo;
  })
  .transition()
    .duration(800)
    .attr("stroke-dashoffset",0);

// Add the X Axis
 svg.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + height + ")")
  .call(xAxis);

// Add the Y Axis
 svg.append("g")
  .attr("class", "y axis")
  .call(yAxis);


  if(margin.transform) {
    var x = margin.transform[0];
    var y = margin.transform[1];
    d3.select("g#chart")
     .attr("transform","translate(" + x + "," + y + ")");
  }
}


function AJAX(obj) {
    $.ajax(obj);
};

function getFormValues() {
    var chkAsignaciones = document.getElementById("chkAsignaciones").checked;
    var chkContratos = document.getElementById("chkContratos").checked;
    var dataTypeGas = document.getElementById("dataTypeGas").checked;
    var dataTypeOil = document.getElementById("dataTypeOil").checked;
    var sYear = document.getElementById("sYear").value;
    var sMonth = document.getElementById("sMonth").value;
    var eYear = document.getElementById("eYear").value;
    var eMonth = document.getElementById("eMonth").value;
    var operator = document.getElementById("dataOperator").value;
    var f = { 'sYear':sYear, 'sMonth':sMonth, 'eYear':eYear, 'eMonth':eMonth };

    function type() {
	var t;
	if(dataTypeGas && dataTypeOil) {
	  t = "oil;gas";
	}
	if(dataTypeGas && !dataTypeOil) {
	  t = "gas";
	}
	if(!dataTypeGas && dataTypeOil) {
	  t = "oil";
	}

	return t;
    };

    function Periodicidad() {
	var periodicidad;
	var arr = document.getElementsByClassName("periodicidad");
	for(var i in arr) {
	  if(arr[i].checked) periodicidad = arr[i].value;
	}

	return periodicidad;
    };

    function fecha(f) {
	var obj = { 'sDate':'', 'eDate':'' };
	obj.sDate = f.sYear + '-' + f.sMonth + '-01';
	obj.eDate = f.eYear + '-' + f.eMonth + '-01';

	return obj;
    };

    var tipos = function() {
	var result = d3.selectAll('input[name=inpTipos]')[0]
	  .filter(function(d) { return d.checked; })
	  .map(function(d) { return d.value; })
	  .reduce(function sum(a,b) { return a + ";" + b; });

	return result + ";";
    };

    var obj = {
	  'type': type(),
	  'sdate': fecha(f).sDate,
	  'edate': fecha(f).eDate,
	  'contract': tipos(),
	  'operator': operator,
	  'category': 'phidro;',
	  'field': 'all;', // <---------------- ¡OJO! Crear función también.
	  'term':Periodicidad()
    };

    return obj;
}

function ajaxConfig() {
    var obj = {
	url:"",
	type:"post",
	datatype:"json",
	data: {},
	success: function(response) {
	   console.log(response);
	},
	error: function() { console.log("!", type()); }
    }

    return obj;
}
